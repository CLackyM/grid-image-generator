<!DOCTYPE html>
<html>
<head>
	<title>Grid image generator</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
	<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
	<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
	<!--[if lt IE 9]><script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script><script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script><![endif]-->
	<style>
		.col-highlight {
			background:rgba(255, 0, 0, 0.40);
			min-height:40px;
		}
		.pre-result-wrapper {
			overflow:scroll;
			max-height:500px;
			max-width:100vw;
			outline:dotted 1px gray;
			padding-top:5px;
		}
		.pre-result-container {
			position:relative;
			min-height:40px;
		}
		.pre-result-container [class*="col-xs-"] {
			background:rgba(255, 0, 0, 0.20);
		}
		.pre-result-row {
			margin-bottom:5px;
			position:relative;
		}
		.edit-row {
			position:absolute;
			opacity:0;
			right:1px;
			top:1px;
			z-index:1;
			background:#fff;
			padding:2px 4px;
		}
		.pre-result-row:hover .edit-row {
			opacity:1;
		}
	</style>
</head>
<body>
	<section>
		<div class="container">
			<div class="row">
				<div class="col-xs-12">
					<h1>Grid image generator for 12 columns grid <small>at this moment with fixed gutter</small></h1>
					<h2>Configure rows with columns</h2>
					<div class="row">
						<div class="col-xs-12 col-sm-7">
							<h4>Presets</h4>
							<div class="_presets-cols-container">
								<div class="row">
									<div class="col-xs-12">
										<button class="btn btn-default">1-1-1-1-1-1-1-1-1-1-1-1</button> <button class="btn btn-default">2-2-2-2-2-2</button> <button class="btn btn-default">3-3-3-3</button> <button class="btn btn-default">4-4-4</button>
									</div>
								</div>
								<br />
								<div class="row">
									<div class="col-xs-12">
										<button class="btn btn-default">12</button> <button class="btn btn-default">11-1</button> <button class="btn btn-default">10-2</button> <button class="btn btn-default">9-3</button> <button class="btn btn-default">8-4</button> <button class="btn btn-default">7-5</button> <button class="btn btn-default">6-6</button> <button class="btn btn-default">5-7</button> <button class="btn btn-default">4-8</button> <button class="btn btn-default">3-9</button> <button class="btn btn-default">2-10</button> <button class="btn btn-default">1-11</button>
									</div>
								</div>
							</div>
						</div>
						<div class="col-xs-12 col-sm-5">
							<h4>Manual</h4>
							Enter max 1-1-1-1-1-1-1-1-1-1-1-1 and min 12 and summ of columns must be 12. <span class="text-muted">for example 2-8-2 or 3-4-5</span>
							<div class="form-inline">
								<input class="form-control _manual-cols-input" type="text" name="name" value="" /> <a class="btn btn-default _add-manual-cols" href="#">Add row</a>
							</div>
							<div class="_warn text-danger"></div>
						</div>
					</div>
					<h2>Set width</h2>
					<div class="row">
						<div class="col-xs-12 col-sm-7">
							<h4>Presets</h4>
							<div class="_presets-width-container">
								<div class="row">
									<div class="col-xs-12">
										<button class="btn btn-default">320</button> <button class="btn btn-default">750</button> <button class="btn btn-default">970</button> <button class="btn btn-default">1170</button>
									</div>
								</div>
							</div>
						</div>
						<div class="col-xs-12 col-sm-5">
							<h4>Manual</h4>
							<input class="form-control _set-width-input" type="number" name="name" value="" />
						</div>
					</div>
					<h2>Gutter</h2>
					Gutter = 30px
					<!--<h2>Set gutter</h2>
					<div class="text-warning">Designer, remember: the gutter should be the same for all sizes! </div>
					<input class="form-control _set-gutter-input" type="number" name="name" value="30" />-->
				</div>
			</div>
		</div>
		<div class="container">
			<div class="row">
				<div class="col-xs-12"><h2>Pre-result</h2></div>
			</div>
		</div>
		<div class="pre-result-wrapper"><div class="container _pre-result-container pre-result-container"></div></div>
		<br />
		<div class="container">
			<div class="row">
				<div class="col-xs-12">
					<button class="btn btn-default _generate" disabled>Generate</button>
					<br /><br />
				</div>
			</div>
			<div class="panel panel-default">
				<div class="panel-heading">
					<div class="row">
						<div class="col-xs-12 col-sm-6"><h3>Result</h3></div>
						<div class="col-xs-12 col-sm-6 text-right"><a download="" href="" class="btn btn-default disabled _download">Download</a></div>
					</div>
				</div>
				<div class="panel-body">
					<img src="" class="img-responsive _result-image" alt="Here will be a picture" />
				</div>
			</div>
		</div>

	</section>

	<script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
	<script src="https://code.jquery.com/jquery-migrate-3.0.0.min.js" integrity="sha256-JklDYODbg0X+8sPiKkcFURb5z7RvlNMIaE3RA2z97vw=" crossorigin="anonymous"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
	<script>
		$(function () {
			"use strict";

			var colsConf = '',
				setWidthInput = $('._set-width-input'),
				setGutterInput = $('._set-gutter-input'),
				resultImage = $('._result-image'),
				downloadButton = $('._download'),
				presetsColsContainer = $('._presets-cols-container'),
				presetsWidthContainer = $('._presets-width-container'),
				manualColsInput = $('._manual-cols-input'),
				addManualCols = $('._add-manual-cols'),
				preResult = $('._pre-result-container'),
				generateButton = $('._generate'),
				warn = $('._warn'),
				canvas = document.createElement("canvas"),
				canvasContext = canvas.getContext("2d"),
				width = 970,
				gutter = 30;
			var editRowTemplate = '<div class="form-inline _edit-row edit-row">			<div class="form-group form-group-sm">				<label >Set row height</label>				<input type="number" class="form-control" value="40">			</div>			<button type="submit" class="btn btn-default btn-sm _set-row-height">Set</button>			OR			<button type="submit" class="btn btn-default btn-sm _delete-row">Delete row</button>		</div>'

			function parseColsValue(val) {
				var arr = val.split('-');
				return validateColsValue(arr) === 12 ? arr : false;
			}
			function validateColsValue(arr) {
				for (var i = 0, sum = 0; i < arr.length; sum += Number(arr[i++]));
				return sum===12?sum:false;
			}
			function addRow(colsVal) {
				warn.html('');
				var colsArr = parseColsValue(colsVal);
				if (colsArr === false) {
					warn.html('invalid format or sum not 12!')
				} else {
					createRow(colsArr);
				}
				generateButton.prop('disabled', generateButtonEnabler());
			}
			function createRow(colsArr) {
				var row = $('<div class="row _pre-result-row pre-result-row"/>');
				var cols = [];
				row.append(editRowTemplate);
				preResult.append(row);
				for (var i = 0; i < colsArr.length; i++) {
					cols.push($('<div class="_pre-result-col col-xs-' + colsArr[i] + '"/>').append('<div class="col-highlight"/>'))

				}
				row.append(cols);
				row.find('._delete-row').click(function () {
					$(this).closest('._pre-result-row').remove();
				})
				row.find('._set-row-height').click(function () {
					setRowHeight($(this).closest('._pre-result-row'), $(this).prev().find('input').val());

				})
			}
			function setRowHeight(row, height) {
				row.find('.col-highlight').height(height);
			};
			function generateButtonEnabler() {
				return preResult.html() === '' ? true : false;
			}
			function generateImage() {
				var imgData;
				var rows = preResult.find('._pre-result-row');
				canvas.width = preResult.outerWidth();
				canvas.height = preResult.height();

				canvasContext.fillStyle = "#ffffff";
				canvasContext.fillRect(0, 0, canvas.width, canvas.height);


				for (var i = 0; i < rows.length; i++) {
					var $row = $(rows[i]);
					var rowHeight = $row.height();
					var rowPosition = $row.position();
					var cols = $row.find('._pre-result-col');
					for (var q = 0; q < cols.length; q++) {
						var $col = $(cols[q]);
						var colWidth = $col.outerWidth(true);
						var colPosition = $col.position();
						var $colHighlight = $($col.find('.col-highlight')[0]);
						var colHighlightWidth = $colHighlight.outerWidth(true);
						var colHighlightPosition = $colHighlight.position();
						canvasContext.fillStyle = "rgba(255, 0, 0, 0.2)";
						canvasContext.fillRect(colPosition.left, rowPosition.top, colWidth, rowHeight);
						canvasContext.fillStyle = "rgba(255, 0, 0, 0.4)";
						canvasContext.fillRect(colPosition.left+colHighlightPosition.left, rowPosition.top, colHighlightWidth, rowHeight);
					}
				}

				imgData = canvas.toDataURL();
				resultImage.attr('src' , imgData);
				downloadButton.attr({
					'download': 'grid-image-width-'+width+'.png',
					'href': imgData
				});
				downloadButton.removeClass('disabled');
			};
			function setPreResultContainerWidth(val) {
				width = val;
				preResult.width(width-gutter);
			}
			setWidthInput.change(function () {
				setPreResultContainerWidth(this.value);
			});
			addManualCols.click(function (e) {
				e.preventDefault();
				addRow(manualColsInput.val());
			});
			presetsColsContainer.find('button').each(function () {
				$(this).click(function () {
					addRow($(this).html());
				})
			})
			presetsWidthContainer.find('button').each(function () {
				$(this).click(function () {
					setPreResultContainerWidth(Number($(this).html()));
				})
			})
			generateButton.click(function () {
				generateImage();
			})
		});
	</script>
</body>
</html>